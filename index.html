<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="onPurposeColorBGIcon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="onPurposeColorBGIcon.svg">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="A Christ-centered community of young adults at Calhoun SDA Church. Because purpose isn't accidental. Join us for events, Bible study, and more.">
  <meta name="theme-color" content="#4e6d64">
  <title>On Purpose | Young Adults</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-dark': '#2a3a35',
            'brand-dark-end': '#252f2c',
            'brand-primary': '#4e6d64',
            'brand-secondary': '#d0b49f',
            'brand-accent': '#e58c62',
            'brand-bg': '#f8f6f3'
          },
          fontFamily: {
            sans: ['Montserrat', 'sans-serif'],
            serif: ['Playfair Display', 'serif'],
          },
          animation: {
            'fade-in': 'fadeIn 1s ease-out forwards'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: 0 },
              '100%': { opacity: 1 }
            }
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    html {
      scroll-behavior: smooth;
    }
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(40px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeInUp 0.8s ease-out both; }
    /* Hero fade-in sequence classes for staggered animation */
    .hero-seq { opacity: 0; animation: fadeInUp 0.8s ease-out forwards; }
    .hero-seq-1 { animation-delay: 0.05s; }
    .hero-seq-2 { animation-delay: 0.20s; }
    .hero-seq-3 { animation-delay: 0.35s; }

    /* Disables animation when user prefers reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .hero-seq,
      .animate-fade-in { animation: none !important; opacity: 1 !important; transform: none !important; }
    }
    /* --- Event card layout & description clamp --- */
    .event-card { display: flex; flex-direction: column; height: 100%; }
    .event-body { flex: 1 1 auto; }

    .desc-clamp { position: relative; max-height: 4.5em; /* ~3 lines at 1.5em */ line-height: 1.5em; overflow: hidden; }
    .desc-clamp.is-clamped::after {
      content: ""; position: absolute; left: 0; right: 0; bottom: 0; height: 2.0em;
      background: linear-gradient(to bottom, rgba(255,255,255,0), #ffffff 80%);
      pointer-events: none;
    }
    /* Match dark text-on-white card background color just in case the theme changes */
    .event-card-bg { background:#ffffff; }
    .toggle-more { display:none; font-weight:600; text-decoration:underline; color:#e58c62; }
    .desc-clamp.expanded { max-height:none; }
    .desc-clamp.expanded::after { display:none; }
    .toggle-more.show { display:inline-block; }
  </style>
</head>
<body class="bg-brand-bg text-brand-primary font-sans">
  <section id="hero" class="relative h-screen bg-gradient-to-b from-brand-dark to-brand-dark-end text-white flex flex-col justify-center items-center text-center px-4">
      <h1 class="hero-seq hero-seq-1">
        <img src="onPurposeWhite.svg" alt="On Purpose Logo" class="h-36 mb-4" />
        <span class="sr-only">On Purpose Young Adults</span>
      </h1>
      <p class="mt-2 text-base italic tracking-wide hero-seq hero-seq-2">Because purpose isn't accidental.</p>
      <p id="verseDisplay" class="mt-6 italic text-lg max-w-2xl mx-auto hero-seq hero-seq-2"></p>
      <a href="#events" class="mt-8 bg-brand-accent text-white font-semibold py-3 px-8 rounded-full shadow-lg hover:shadow-xl hover:opacity-95 hover:-translate-y-1 transition transform duration-200 tracking-wide uppercase hero-seq hero-seq-3">See What's Happening</a>
  </section>

  <section class="py-16 px-4 sm:px-6 bg-white border-t-4 border-brand-secondary" id="about">
    <div class="max-w-3xl mx-auto text-center">
      <h2 class="text-3xl font-serif font-bold mb-4 text-brand-primary">Who We Are</h2>
      <div class="h-1 bg-brand-secondary w-24 mx-auto my-6 rounded-full"></div>
      <p class="text-lg leading-relaxed font-light text-brand-primary">
        We're a community of young adults at Calhoun SDA Church living life <strong class="font-bold">On Purpose</strong>. Through Bible study, service, and fun social events, we aim to grow spiritually, connect deeply, and make a difference together.
      </p>
    </div>
  </section>

  <section class="py-16 px-4 sm:px-6 scroll-fade" id="events">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-3xl font-serif font-bold text-center mb-10 text-brand-primary">Upcoming Events</h2>

      <div id="countdown" class="font-sans text-lg md:text-xl text-center mb-12 italic text-gray-700"></div>
      <div id="eventCards" class="grid md:grid-cols-2 gap-8 gap-y-12"></div>

      <div class="bg-brand-secondary/20 border border-brand-secondary/30 rounded-lg p-6 md:p-8 mt-12">
        <div class="flex flex-col md:flex-row justify-center items-center gap-8 md:gap-12">
          <div class="flex items-center gap-4">
            <div class="flex-shrink-0 bg-white p-3 rounded-full shadow-sm">
              <svg class="w-8 h-8 text-brand-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h22.5" />
              </svg>
            </div>
            <div>
              <h3 class="text-xl font-serif font-bold text-brand-primary">Sabbath School Bible Study</h3>
              <p class="text-brand-primary/80">Every Sabbath at 10:00 AM</p>
            </div>
          </div>
          <div class="w-24 h-px bg-brand-secondary/50 md:hidden"></div>
          <div class="flex items-center gap-4">
            <div class="flex-shrink-0 bg-white p-3 rounded-full shadow-sm">
              <svg class="w-8 h-8 text-brand-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
              </svg>
            </div>
            <div>
              <h3 class="text-xl font-serif font-bold text-brand-primary">Location</h3>
              <p class="text-brand-primary/80">Right side of God's Pantry at Calhoun SDA</p>
            </div>
          </div>
        </div>
      </div>
      </div>
  </section>

  <footer class="bg-brand-dark text-white py-8 text-center relative">
    <p>&copy; <span id="year"></span> On Purpose â€¢ Calhoun SDA Young Adults</p>
    <div class="mt-4 flex flex-col sm:flex-row justify-center gap-6 text-sm text-gray-400">
      <div>
        Follow us on Instagram
        <a href="https://instagram.com/onpurpose.ya" target="_blank" class="underline hover:text-white transition">@onpurpose.ya</a>
      </div>
      <div>
        Contact us at
        <a href="mailto:info@onpurposeya.com" class="underline hover:text-white transition">info@onpurposeya.com</a>
      </div>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("year").textContent = new Date().getFullYear();
      document.getElementById("verseDisplay").textContent = "\u201cAnd we know that in all things God works for the good of those who love him, who have been called according to his purpose.\u201d - Romans 8:28";
      document.querySelectorAll('.scroll-fade').forEach(section => {
        gsap.fromTo(section, { opacity: 0, y: 40 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out', scrollTrigger: { trigger: section, start: 'top 85%' } });
      });
      loadCalendarEvents();

    });

    function updateCountdownTo(date) {
      const el = document.getElementById("countdown");
      function update() {
        const now = new Date();
        const diff = date - now;
        if (diff <= 0) {
          el.innerHTML = "Our next event is happening now!";
          return;
        }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const m = Math.floor((diff / (1000 * 60)) % 60);
        const s = Math.floor((diff / 1000) % 60);
        el.textContent = `${d}d ${h}h ${m}m ${s}s until our next event`;
      }
      update();
      setInterval(update, 1000);
    }

    // Safely escape text so it doesn't render as HTML
    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, (c) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }

    // Find the first usable URL in text (handles <a>, https://, www., and bare domains)
    function findFirstUrlAndClean(text) {
      const src = text || "";

      // 1) Try to parse any HTML and extract/remove the first anchor tag href
      const div = document.createElement('div');
      div.innerHTML = src;
      const firstAnchor = div.querySelector('a[href]');
      let link = null;
      if (firstAnchor) {
        const href = firstAnchor.getAttribute('href');
        if (href) link = href.trim();
        firstAnchor.remove(); // remove the anchor from rendered description
      }

      // Remaining plain text (also covers cases where description was HTML-encoded)
      let plain = (div.textContent || '').trim();

      // 2) If we didn't get a link from an <a>, look for URL-like text in the remaining string.
      const urlRe = /(?:https?:\/\/[^\s<>"']+|www\.[^\s<>"']+|(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z]{2,}(?:\/[^\s<>"']*)?)/gi;
      const emailRe = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi;

      if (!link) {
        let m;
        while ((m = urlRe.exec(plain))) {
          const candidate = m[0];
          // skip emails
          if (!candidate.match(emailRe)) {
            link = candidate.startsWith('http') ? candidate : ('https://' + candidate.replace(/^www\./, ''));
            break;
          }
        }
      }

      // 3) Remove *all* URL-like substrings from the description so they don't render in the card
      const cleaned = plain.replace(urlRe, '').replace(/\s{2,}/g, ' ').trim();

      return { link, cleaned };
    }

    async function loadCalendarEvents() {
      const container = document.getElementById('eventCards');
      container.innerHTML = '<p class="text-center col-span-2">Loading events...</p>';
      try {
        const res = await fetch('https://onpurpose-events.jdawg2450.workers.dev/');
        const data = await res.json();
        const now = new Date();
        const events = (data.items || []).filter(e => new Date(e.start.dateTime || e.start.date) > now).slice(0, 4);
        const nextEvent = events[0];
        if (nextEvent) {
          document.getElementById('countdown').style.display = 'block';
          updateCountdownTo(new Date(nextEvent.start.dateTime || nextEvent.start.date));
        } else {
          document.getElementById('countdown').style.display = 'none';
        }
        container.innerHTML = '';
        if (events.length === 0) {
          container.innerHTML = '<p class="text-center col-span-2">No upcoming events right now. Check back soon!</p>';
        } else {
          // Determine if ANY event has a non-empty cleaned description
          const hasAnyDescription = events.some(event => {
            const desc = event.description || '';
            const processed = findFirstUrlAndClean(desc);
            return processed.cleaned && processed.cleaned.trim().length > 0;
          });
          events.forEach(event => {
            // ================== START: CORRECTED CODE ==================
            const isAllDay = !!event.start.date;
            let start, formatted;

            if (isAllDay) {
              // For "YYYY-MM-DD", treat it as local time by adding a time component.
              // Using timeZone: 'UTC' in options then prevents the local timezone from shifting it again during formatting.
              start = new Date(event.start.date + 'T00:00:00');
              const options = {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                timeZone: 'UTC'
              };
              formatted = start.toLocaleDateString('en-US', options);
            } else {
              // For events with a specific time, the full ISO string is fine.
              start = new Date(event.start.dateTime);
              const options = {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
              };
              formatted = start.toLocaleDateString('en-US', options);
            }
            // =================== END: CORRECTED CODE ===================

            // Prepare description and choose link:
            let rawDescription = event.description || '';
            let eventLink = event.htmlLink;

            const processed = findFirstUrlAndClean(rawDescription);
            if (processed.link) {
              eventLink = processed.link;
            }
            const description = processed.cleaned;

            const card = document.createElement('div');
            card.className = "event-card event-card-bg border-l-4 border-brand-accent bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition overflow-hidden";
            card.innerHTML = `
              <div class="event-body">
                <h3 class="text-xl font-serif font-bold text-brand-primary">${event.summary}</h3>
                <p class="font-sans text-sm text-gray-600">${formatted}</p>
                ${
                  description && description.trim().length > 0
                    ? `<p class=\"desc-clamp text-gray-700 break-words mt-4\">${escapeHTML(description)}</p>`
                    : (hasAnyDescription ? `<p class=\"desc-clamp mt-4\"></p>` : ``)
                }
              </div>
              <div class="mt-4">
                <button type="button" class="toggle-more mt-2 text-xs text-gray-500 underline">Read more</button>
                <a href="${eventLink}" class="mt-2 text-brand-accent font-semibold underline hover:opacity-80 transition block">View Event Details</a>
              </div>
            `;
            container.appendChild(card);

            // Clamp logic: if the description overflows, add fade + show toggle
            const descEl = card.querySelector('.desc-clamp');
            const moreBtn = card.querySelector('.toggle-more');
            if (descEl && descEl.textContent.trim().length > 0) {
              // Allow layout to compute then test overflow
              requestAnimationFrame(() => {
                if (descEl.scrollHeight > descEl.clientHeight + 2) {
                  descEl.classList.add('is-clamped');
                  moreBtn.classList.add('show');
                  moreBtn.addEventListener('click', () => {
                    const expanded = descEl.classList.toggle('expanded');
                    if (expanded) {
                      descEl.classList.remove('is-clamped');
                      moreBtn.textContent = 'Show less';
                    } else {
                      descEl.classList.add('is-clamped');
                      moreBtn.textContent = 'Read more';
                    }
                  });
                }
              });
            }
          });
        }
      } catch (err) {
        console.error('Failed to load events:', err);
        container.innerHTML = '<p class="text-center col-span-2 text-red-500">Failed to load events. Try again later.</p>';
      }
    }
  </script>
</body>
</html>
